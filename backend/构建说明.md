# Linux 构建说明

## 快速构建

### 方法 1: 使用批处理脚本（Windows）

```bash
cd backend
build-linux.bat
```

### 方法 2: 手动构建（Windows PowerShell）

```powershell
cd backend
$env:GOOS="linux"
$env:GOARCH="amd64"
go build -ldflags "-s -w" -o dist/webcheckly-linux-amd64 main.go
```

### 方法 3: 手动构建（Linux/macOS）

```bash
cd backend
GOOS=linux GOARCH=amd64 go build -ldflags "-s -w" -o dist/webcheckly-linux-amd64 main.go
```

## 构建输出

构建成功后，可执行文件将保存在 `backend/dist/` 目录：

- `webcheckly-linux-amd64` - Linux amd64 版本（适用于大多数 Linux 服务器）

## 部署到 Linux 服务器

1. **上传文件**
   ```bash
   scp backend/dist/webcheckly-linux-amd64 user@server:/www/wwwroot/webcheckly/
   ```

2. **设置执行权限**
   ```bash
   chmod +x /www/wwwroot/webcheckly/webcheckly-linux-amd64
   ```

3. **配置环境变量**（创建 `.env` 文件或设置系统环境变量）
   ```bash
   export DATABASE_URL="postgres://user:password@localhost:5432/webcheckly?sslmode=disable"
   export JWT_SECRET="your-secret-key-here"
   export PORT="8080"
   ```

4. **运行**
   ```bash
   ./webcheckly-linux-amd64
   ```

## 安装系统依赖

在运行后端服务之前，需要安装以下工具：

### 方法 1: 使用自动安装脚本（推荐）

```bash
# 上传安装脚本到服务器
scp backend/install-dependencies.sh user@server:/www/wwwroot/webcheckly/

# SSH 登录服务器
ssh user@server

# 修复行尾符问题（如果从 Windows 上传）
# 如果遇到 "$'\r': command not found" 错误，执行以下命令之一：

# 方法 1: 使用 tr（最可靠，推荐）
tr -d '\r' < /www/wwwroot/webcheckly/install-dependencies.sh > /www/wwwroot/webcheckly/install-dependencies.sh.fixed
mv /www/wwwroot/webcheckly/install-dependencies.sh.fixed /www/wwwroot/webcheckly/install-dependencies.sh

# 方法 2: 使用 dos2unix（如果已安装）
# dos2unix /www/wwwroot/webcheckly/install-dependencies.sh

# 方法 3: 使用 sed
# sed -i 's/\r$//' /www/wwwroot/webcheckly/install-dependencies.sh

# 运行安装脚本
cd /www/wwwroot/webcheckly
chmod +x install-dependencies.sh
./install-dependencies.sh
```

### 方法 2: 手动安装

#### 1. 安装 Katana（必需，用于全站链接检查）

**使用 Go 安装（推荐）：**
```bash
go install github.com/projectdiscovery/katana/cmd/katana@latest
# 确保 $HOME/go/bin 在 PATH 中
export PATH="$PATH:$HOME/go/bin"
```

**或下载预编译二进制：**
```bash
# 下载最新版本
wget https://github.com/projectdiscovery/katana/releases/latest/download/katana_*_linux_amd64.zip
unzip katana_*_linux_amd64.zip
sudo mv katana /usr/local/bin/
chmod +x /usr/local/bin/katana
```

**验证安装：**
```bash
katana -version
```

#### 2. 安装 Lighthouse（必需，用于性能/SEO/安全/可访问性检测）

**安装 Node.js（如果未安装）：**
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS/RHEL
curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash -
sudo yum install -y nodejs
```

**安装 Lighthouse：**
```bash
sudo npm install -g lighthouse
```

**验证安装：**
```bash
lighthouse --version
```

#### 3. 安装 httpx（可选，用于快速链接健康检查）

**使用 Go 安装：**
```bash
go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
export PATH="$PATH:$HOME/go/bin"
```

**或下载预编译二进制：**
```bash
wget https://github.com/projectdiscovery/httpx/releases/latest/download/httpx_*_linux_amd64.zip
unzip httpx_*_linux_amd64.zip
sudo mv httpx /usr/local/bin/
chmod +x /usr/local/bin/httpx
```

**验证安装：**
```bash
httpx -version
```

## 注意事项

- **必需工具**：`katana` 和 `lighthouse` 是必需的工具，缺少它们会导致相关功能无法使用
- **PATH 配置**：确保所有工具都在系统 PATH 中，可以通过 `which katana` 和 `which lighthouse` 验证
- **权限问题**：如果使用 `sudo` 安装，确保运行服务的用户有权限执行这些命令
- **数据库连接**：确保数据库连接配置正确
- **服务管理**：建议使用 systemd 或 supervisor 管理服务

## 验证安装

在运行服务前，验证所有工具是否可用：

```bash
# 检查 Katana
katana -version

# 检查 Lighthouse
lighthouse --version

# 检查 httpx（可选）
httpx -version
```

如果所有命令都能正常执行，说明依赖安装成功。

详细说明请参考 `BUILD.md` 和 `README.md`。
