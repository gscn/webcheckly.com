# 支付流程对齐说明

项目有两种支付方式：**购买积分**（一次性支付）与 **订阅**（基础版 / 专业版 / 高级版，按月扣款）。前后端接口与跳转需严格区分，确保两条流程完整、不混用。

---

## 一、购买积分（一次性支付）

| 环节 | 前端 | 后端 | 说明 |
|------|------|------|------|
| 创建订单 | `createOrder('credits_purchase', undefined, amountUSD, 'paypal')` | `POST /api/orders/create` | `order_type=credits_purchase`，`amount` 为美元 |
| 创建结账 | `createCheckoutSession(order.id, 'paypal')` | `POST /api/payment/create-checkout` | `order_id` 为我们订单 ID，`payment_method=paypal` |
| 跳转支付 | `redirectToPayment(result.url)` | - | 跳转 PayPal Approve URL 或 Stripe Checkout |
| 成功回调 | `/payment/success?order_id=...`（PayPal）或 `?session_id=...`（Stripe） | - | 仅一次性支付使用 |
| 取消回调 | `/payment/cancel` | - | 仅一次性支付使用 |
| Success 页 | 读 `order_id` / `session_id` → `confirmPayment`（PayPal）→ `verifyPayment` / `verifyPaymentBySessionId` | `POST /api/payment/confirm`、`GET /api/payment/verify/:orderId`、`GET /api/payment/verify-session?session_id=` | 展示支付结果 |

**后端 Success/Cancel URL 环境变量（一次性）：**

- `PAYPAL_PAYMENT_SUCCESS_URL`、`PAYPAL_PAYMENT_CANCEL_URL`
- `STRIPE_PAYMENT_SUCCESS_URL`、`STRIPE_PAYMENT_CANCEL_URL`

**前端页面：**

- `/payment/success`、`/payment/cancel`

---

## 二、订阅（基础版 / 专业版 / 高级版，按月）

| 环节 | 前端 | 后端 | 说明 |
|------|------|------|------|
| 创建订阅 | `createSubscription(planType, 'paypal')` | `POST /api/subscription/subscribe` | `plan_type`: `basic` / `pro` / `enterprise`，`payment_method=paypal` |
| 跳转支付 | `redirectToPayment(result.url)` | - | 跳转 PayPal 订阅 Approve 或 Stripe 订阅 Checkout |
| 成功回调 | `/subscription/success` | - | 仅订阅使用，无 `order_id` |
| 取消回调 | `/subscription/cancel` | - | 仅订阅使用 |
| Success 页 | 轮询 `getUserSubscription()`（`GET /api/subscription/status`），若已激活则展示套餐名 | - | 订阅激活通常由 Webhook 异步处理 |

**后端 Success/Cancel URL 环境变量（订阅）：**

- `PAYPAL_SUBSCRIPTION_SUCCESS_URL`、`PAYPAL_SUBSCRIPTION_CANCEL_URL`
- `STRIPE_SUBSCRIPTION_SUCCESS_URL`、`STRIPE_SUBSCRIPTION_CANCEL_URL`

**前端页面：**

- `/subscription/success`、`/subscription/cancel`

---

## 三、流程隔离与禁止混用

- **购买积分**：仅走 `orders/create` → `payment/create-checkout` → `/payment/success`、`/payment/cancel`。不使用 `subscription/subscribe` 或 `/subscription/*`。
- **订阅**：仅走 `subscription/subscribe` → `/subscription/success`、`/subscription/cancel`。不使用 `orders/create`、`payment/create-checkout` 或 `/payment/*`。

---

## 四、接口速查

| 用途 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 一次性-创建订单 | POST | `/api/orders/create` | `order_type`、`amount`、`payment_method` |
| 一次性-创建结账 | POST | `/api/payment/create-checkout` | `order_id`、`payment_method` |
| 一次性-确认支付 | POST | `/api/payment/confirm` | `order_id`（PayPal capture） |
| 一次性-验证支付 | GET | `/api/payment/verify/:orderId` | 按订单 ID |
| 一次性-验证 Session | GET | `/api/payment/verify-session?session_id=` | Stripe 用 |
| 订阅-创建 | POST | `/api/subscription/subscribe` | `plan_type`、`payment_method` |
| 订阅-状态 | GET | `/api/subscription/status` | 当前用户订阅 |
| 订阅-套餐列表 | GET | `/api/subscription/plans` | 基础 / 专业 / 高级 |

---

## 五、默认 Success/Cancel 路径（未配置 env 时）

- 一次性：`/payment/success`、`/payment/cancel`
- 订阅：`/subscription/success`、`/subscription/cancel`

与前端路由一致；生产环境通过对应 env 覆盖为正式域名即可。
